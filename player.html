<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Подключаем шрифты с поддержкой кириллицы -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Kelly+Slab&family=Lobster&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Nunito:wght@400;700&family=Open+Sans:wght@400;700&family=Pacifico&family=Playfair+Display:wght@400;700&family=Poppins:wght@400;600&family=Press+Start+2P&family=Roboto+Mono&family=Ruslan+Display&family=Underdog&display=swap&subset=cyrillic" rel="stylesheet">
    
    <style>
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --player-accent-color: #00c6ff;
            --player-bg-color-dynamic: rgba(26, 26, 46, 0.7);
            --neon-color: #00FFFF;
            --font-family: 'Poppins', sans-serif;
        }
        
        body {
            font-family: var(--font-family), sans-serif;
            background-color: transparent;
            margin: 0; padding: 0;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        /* Обертка для масштабирования без обрезания */
        .scale-wrapper {
            transform-origin: center center;
            display: flex; align-items: center; justify-content: center;
        }

        .player-container {
            width: 100%; height: 100%;
            display: flex;
            background-color: var(--player-bg-color-dynamic);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease;
            padding: 15px;
            border-radius: 20px;
        }

        .player-container.neon {
            box-shadow: 0 0 10px var(--neon-color), 0 0 25px var(--neon-color), 0 0 50px var(--neon-color);
        }

        /* Компактный режим (строка) */
        .player-container.compact { flex-direction: row; }
        .player-container.compact .main-view { flex-direction: row; }
        
        /* Полный режим (колонка) */
        .player-container.full { flex-direction: column; }
        .player-container.full .main-view { flex-direction: column; }

        .main-view {
            display: flex; width: 100%; height: 100%; gap: 15px; flex-grow: 1; min-height: 0;
        }

        .controls-info {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; gap: 5px;
            min-width: 0;
        }
        
        .album-art {
            width: 140px; height: 140px; border-radius: 15px; object-fit: cover; flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background-color: #000;
        }
        /* В полном режиме обложка по центру */
        .player-container.full .album-art { align-self: center; width: 120px; height: 120px; }

        .track-info { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; text-shadow: 0 0 5px rgba(0,0,0,0.5); margin-bottom: 5px;}
        #track-title { font-size: 20px; font-weight: 600; margin: 0; }
        #track-artist { font-size: 14px; opacity: 0.8; margin: 0; }
        
        .progress-container { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 12px; margin: 5px 0;}
        #progress-bar {
            -webkit-appearance: none; width: 100%; height: 5px; background: rgba(255, 255, 255, 0.3);
            border-radius: 5px; outline: none; cursor: pointer;
        }
        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
            background: var(--player-accent-color); border-radius: 50%; border: 2px solid #fff;
        }
        
        .player-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px;}
        .control-btn { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .control-btn:hover, .control-btn.active { color: var(--player-accent-color); transform: scale(1.1); }
        #play-pause-btn { font-size: 34px; }
        
        #visualizer { width: 100%; height: 30px; opacity: 0.6; }
        
        .playlist-container { 
            display: none; /* Скрыт в компактном */
            overflow-y: auto; margin-top: 15px; width: 100%; 
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
            flex-grow: 1; min-height: 0;
        }
        .player-container.full .playlist-container { display: block; }

        #playlist { list-style: none; padding: 0; margin: 0; }
        .playlist-item { padding: 8px 10px; border-radius: 5px; font-size: 13px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .playlist-item:hover { background-color: rgba(255,255,255,0.1); }
        .playlist-item.playing { background-color: var(--player-accent-color); color: #fff; font-weight: bold; }
        
        /* Скроллбар */
        .playlist-container::-webkit-scrollbar { width: 6px; }
        .playlist-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="scaleWrapper" class="scale-wrapper">
        <div id="player" class="player-container compact">
            <div class="main-view">
                <img id="albumArt" class="album-art" src="" alt="Art" onerror="this.style.display='none'">
                <div class="controls-info">
                    <div class="track-info">
                        <p id="trackTitle">Loading...</p>
                        <p id="trackArtist">...</p>
                    </div>
                    <canvas id="visualizer"></canvas>
                    <div class="progress-container">
                        <span id="currentTime">0:00</span>
                        <input type="range" id="progressBar" value="0" step="1">
                        <span id="totalDuration">0:00</span>
                    </div>
                    <div class="player-controls">
                        <button class="control-btn" id="shuffleBtn"><i class="fas fa-random"></i></button>
                        <button class="control-btn" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="control-btn" id="playPauseBtn"><i class="fas fa-play-circle"></i></button>
                        <button class="control-btn" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                        <button class="control-btn" id="repeatBtn"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
            </div>
            <div class="playlist-container"><ul id="playlist"></ul></div>
        </div>
    </div>

    <audio id="audioSource" crossorigin="anonymous"></audio>

    <script>
        const scaleWrapper = document.getElementById('scaleWrapper');
        const player = document.getElementById('player');
        const audio = document.getElementById('audioSource');
        const albumArt = document.getElementById('albumArt');
        const trackTitle = document.getElementById('trackTitle');
        const trackArtist = document.getElementById('trackArtist');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalDurationEl = document.getElementById('totalDuration');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const playlistEl = document.getElementById('playlist');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        let tracks = [], currentTrackIdx = 0, isPlaying = false, isShuffle = false, isRepeat = false;
        let audioCtx, analyser, source, dataArray, isVisualizerInit = false;
        let baseW = 500, baseH = 180;

        function hexToRgba(hex, alpha) {
            let r=0, g=0, b=0;
            if(hex.length===4){r=parseInt(hex[1]+hex[1],16);g=parseInt(hex[2]+hex[2],16);b=parseInt(hex[3]+hex[3],16);}
            else if(hex.length===7){r=parseInt(hex.substring(1,3),16);g=parseInt(hex.substring(3,5),16);b=parseInt(hex.substring(5,7),16);}
            return `rgba(${r},${g},${b},${alpha})`;
        }

        // Надежное масштабирование
        function fitToScreen() {
            // Оставляем 4% отступа (0.96), чтобы тени не резались
            const scale = Math.min(window.innerWidth / baseW, window.innerHeight / baseH) * 0.96;
            scaleWrapper.style.width = baseW + 'px';
            scaleWrapper.style.height = baseH + 'px';
            scaleWrapper.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', fitToScreen);

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            applySettings(params);
            parseTracks(params.get('tracks'));
            fitToScreen();
            setTimeout(fitToScreen, 100);
        };

        function applySettings(params) {
            const root = document.documentElement;
            const size = params.get('size') || 'compact';
            const color = params.get('color') || '#4B0082';
            
            // Цвет
            const rgbaColor = hexToRgba(color, 0.75);
            root.style.setProperty('--player-bg-color-dynamic', rgbaColor);
            
            // Шрифт
            root.style.setProperty('--font-family', params.get('font') || 'Poppins');

            // Неон
            if (params.get('neon') === 'true') {
                player.classList.add('neon');
                root.style.setProperty('--neon-color', params.get('neonColor') || '#FF00FF');
            } else {
                player.classList.remove('neon');
            }

            // Размер
            player.classList.remove('compact', 'full');
            if (size === 'full') {
                player.classList.add('full');
                baseW = 800; baseH = 400;
            } else {
                player.classList.add('compact');
                baseW = 500; baseH = 180;
            }

            albumArt.src = params.get('cover') || 'https://via.placeholder.com/150';
            // Если картинка не загрузится, включится display:none из html
            albumArt.style.display = 'block'; 
            
            fitToScreen();
        }

        function parseTracks(str) {
            if (!str) return;
            try {
                tracks = decodeURIComponent(str).split('|||').filter(Boolean).map(line => {
                    let [url, name] = line.split('|').map(s => s.trim());
                    if (!name) {
                        try {
                            name = decodeURIComponent(url.split('/').pop().replace(/\.mp3.*$/i, '').replace(/[\-_]/g, ' '));
                        } catch(e) { name = "Unknown Track"; }
                    }
                    return { url, name };
                });
                if (tracks.length > 0) { buildPlaylist(); loadTrack(0); }
            } catch(e) {}
        }

        function loadTrack(i) {
            currentTrackIdx = i; audio.src = tracks[i].url;
            trackTitle.textContent = tracks[i].name; trackArtist.textContent = "Now Playing";
            progressBar.value = 0; updatePlaylistUI();
        }
        function playTrack() { if(!isVisualizerInit) initVisualizer(); audio.play().then(()=>{isPlaying=true; playPauseBtn.innerHTML='<i class="fas fa-pause-circle"></i>';}).catch(()=>{}); }
        function pauseTrack() { audio.pause(); isPlaying=false; playPauseBtn.innerHTML='<i class="fas fa-play-circle"></i>'; }
        function togglePlay() { if(tracks.length) isPlaying?pauseTrack():playTrack(); }
        
        function nextTrack() {
            let nextIdx = isShuffle ? Math.floor(Math.random()*tracks.length) : currentTrackIdx + 1;
            if (nextIdx >= tracks.length && !isRepeat && !isShuffle) { pauseTrack(); return; }
            currentTrackIdx = nextIdx % tracks.length;
            loadTrack(currentTrackIdx); playTrack();
        }
        
        function prevTrack() { currentTrackIdx = (currentTrackIdx - 1 + tracks.length) % tracks.length; loadTrack(currentTrackIdx); playTrack(); }

        audio.addEventListener('timeupdate', () => { if(audio.duration) { progressBar.value = (audio.currentTime/audio.duration)*100; currentTimeEl.textContent = fmtTime(audio.currentTime); totalDurationEl.textContent = fmtTime(audio.duration); }});
        progressBar.addEventListener('input', (e) => { audio.currentTime = (e.target.value/100)*audio.duration; });
        
        audio.addEventListener('ended', () => { 
            if(isRepeat) { audio.currentTime=0; playTrack(); } 
            else { isPlaying = false; playPauseBtn.innerHTML='<i class="fas fa-play-circle"></i>'; }
        });
        
        function fmtTime(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        
        function buildPlaylist() { 
            playlistEl.innerHTML = ''; 
            tracks.forEach((t, i) => { 
                const li = document.createElement('li'); li.className = 'playlist-item'; li.textContent = t.name; 
                li.onclick = () => { loadTrack(i); playTrack(); }; playlistEl.appendChild(li); 
            }); 
        }
        function updatePlaylistUI() { Array.from(playlistEl.children).forEach((li, i) => li.classList.toggle('playing', i === currentTrackIdx)); }

        playPauseBtn.onclick = togglePlay; nextBtn.onclick = nextTrack; prevBtn.onclick = prevTrack;
        shuffleBtn.onclick = () => { isShuffle=!isShuffle; shuffleBtn.classList.toggle('active', isShuffle); };
        repeatBtn.onclick = () => { isRepeat=!isRepeat; repeatBtn.classList.toggle('active', isRepeat); };

        function initVisualizer() {
            if(isVisualizerInit) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser); analyser.connect(audioCtx.destination);
                analyser.fftSize = 64; dataArray = new Uint8Array(analyser.frequencyBinCount);
                isVisualizerInit = true; animate();
            } catch(e) {}
        }
        function animate() {
            requestAnimationFrame(animate); if(!isPlaying){ctx.clearRect(0,0,canvas.width,canvas.height);return;}
            analyser.getByteFrequencyData(dataArray); ctx.clearRect(0,0,canvas.width,canvas.height);
            const barW = (canvas.width/dataArray.length)*2; let x=0;
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--player-accent-color').trim();
            for(let i=0; i<dataArray.length; i++) { const h = dataArray[i]/255*canvas.height; ctx.fillRect(x, canvas.height-h, barW, h); x+=barW+1; }
        }
    </script>
</body>
</html>
